
.. _throughput_benchmark:

============
消息吞吐测试
============

EMQ消息吞吐测试组合条件：

+--------------------------+-----------------------+------------------+-------------------+--------------+---------------+-------------+
|         QoS              |         Payload       | PUB连接 x Fan-In | SUB连接 X Fan-Out |  实际Fan-In  |  实际Fan-Out  |  背景连接   |
+========+========+========+========+======+=======+==================+===================+==============+===============+=============+
|   0    |   1    |    2   |  256B  |  1k  |  10K  |    C x Msg/s     |     C x Msg/s     |  Msg/s, Bps  |  Msg/s, Bps   |    100K     |
+--------+--------+--------+--------+------+-------+------------------+-------------------+--------------+---------------+-------------+

参数说明:

+-----------+-----------------------+
|  参数     |   说明                |
+-----------+-----------------------+
|  C        |   Connection连接数    |
+-----------+-----------------------+
|  Msg/s    |   每秒消息数量        |
+-----------+-----------------------+
|  Bps      |   网络吞吐(字节/秒)   |
+-----------+-----------------------+

.. NOTE:: 吞吐测试在青云北京三区进行，主机之间的网络带宽平均限制为512Mbps，峰值限制为1Gbps。EMQ吞吐最高只能测试到50MBps。

-------------------
QoS0 Fan-In消息吞吐
-------------------

测试客户端到EMQ服务器间的QoS0消息吞吐:

+-------------------------+-------+-----------+--------------------+---------------------+---------------------+-------------+
| 组合场景ID              |  QoS  |  Payload  |  PUB连接 X Fan-In  |  SUB连接 X Fan-Out  |  Fan-In(平均/峰值)  |  背景连接   | 
+=========================+=======+===========+====================+=====================+=====================+=============+
| qos0-p256-40K-0         |  0    |  256      |  4K X 10           |  0                  |  28843 / 33319      |  100K       |
+-------------------------+-------+-----------+--------------------+---------------------+---------------------+-------------+
| qos0-p1K-30K-0          |  0    |  1K       |  3K X 10           |  0                  |  25720 / 27801      |  100K       |
+-------------------------+-------+-----------+--------------------+---------------------+---------------------+-------------+
| qos0-p10K-10K-0         |  0    |  10K      |  1K X 10           |  0                  |  4480 / 7990        |  100K       |
+-------------------------+-------+-----------+--------------------+---------------------+---------------------+-------------+
| qos0-100K-1K-0          |  0    |  100K     |  1K X 1            |  0                  |  147 / 446          |  100K       |
+-------------------------+-------+-----------+--------------------+---------------------+---------------------+-------------+

.. NOTE:: 1. 测试主机的内核TCP协议栈参数: http://emqtt.com/docs/v2/tune.html#tcp, 2. 100K测试用例吞吐与报文不匹配，问题待确认。

资源占用报告:

+--------------------------+-----------------------+------------+---------------+-----------------+---------------------------+
|  组合场景ID              | 网络吞吐(Avg/Max Bps) | 负载(Load) | CPU(user/sys) | Memory(Avg/Max) | 测试报告                  |
+==========================+=======================+============+===============+=================+===========================+
|  qos0-p256-40K-0         |  /12.06M              | 7/4/2      | 不超过80% / 7%| _/3.8G          | `mqtt_pub_0_256p_10mps`_  |
+--------------------------+-----------------------+------------+---------------+-----------------+---------------------------+
|  qos0-p1K-30K-0          | _/30.88M              | 8/5/3      | 不超过93% / 3%| _/7.4G          | `mqtt_pub_0_1k_10mps`_    |
+--------------------------+-----------------------+------------+---------------+-----------------+---------------------------+
|  qos0-p10K-10K-0         | _/61.88M              | 8/5/3      | 不超过89% / 7%| _/3.8G          | `mqtt_pub_0_10k_10mps`_   |
+--------------------------+-----------------------+------------+---------------+-----------------+---------------------------+
|  qos0-100K-1K-0          | _/38.3M               | 8/6/3      | 不超过62% /22%| _/7.45G         | `mqtt_pub_0_100k_10mps`_  |
+--------------------------+-----------------------+------------+---------------+-----------------+---------------------------+

--------------------
QoS0 Fan-Out消息吞吐
--------------------

+--------------------------+-------+-----------+--------------------+---------------------+---------------------+-------------+
|  组合场景ID              |  QoS  |  Payload  |  PUB连接 X Fan-In  |  SUB连接 X Fan-Out  |  Fan-Out(平均/峰值) |  背景连接   |
+==========================+=======+===========+====================+=====================+=====================+=============+
|  qos0-p256-4-40K         |  0    |  256      |  4 X 1             |  10K X 4            |  40K / 42.5K        |  100K       |
+--------------------------+-------+-----------+--------------------+---------------------+---------------------+-------------+
|  qos0-p1K-3-30K          |  0    |  1K       |  3 X 1             |  10K X 3            |  28K / 32.9K        |  100K       |
+--------------------------+-------+-----------+--------------------+---------------------+---------------------+-------------+
|  qos0-p10K-1-10K         |  0    |  10K      |  1 X 1             |  10K X 1            |  3K / 3.6K          |  100K       |
+--------------------------+-------+-----------+--------------------+---------------------+---------------------+-------------+
|  qos0-p100K-1-1K         |  0    |  100K     |  1 X 1             |  1K X 1             |  0.2K / 0.3K        |  100K       |
+--------------------------+-------+-----------+--------------------+---------------------+---------------------+-------------+

.. TODO:: P100K测试待确认.

资源占用报告:

+--------------------------+-----------------------+------------+---------------+-----------------+---------------------------+
|  组合场景ID              | 网络吞吐(Avg/Max Bps) | 负载(Load) | CPU(user/sys) | Memory(Avg/Max) | 测试报告                  |
+==========================+=======================+============+===============+=================+===========================+
|  qos0-p256-4-40K         | _16.89M               | 8/5/3      | 不超过87% / 7%| _/2.4G          | `mqtt_sub_0_256p_1mps`_   |
+--------------------------+-----------------------+------------+---------------+-----------------+---------------------------+
|  qos0-p1K-3-30K          | _/33M                 | 8/4/2      | 不超过93% / 6%| _/4.4G          | `mqtt_sub_0_1kp_1mps`_    |
+--------------------------+-----------------------+------------+---------------+-----------------+---------------------------+
|  qos0-p10K-1-10K         | _/37.5M               | 8/5/2      | 不超过60% /19%| _/6.0G          | `mqtt_sub_0_10kp_1mps`_   |
+--------------------------+-----------------------+------------+---------------+-----------------+---------------------------+
|  qos0-p100K-1-1K         | _/30.49M              | 8/5/3      | 不超过52% /19%| _/7.82G         | `mqtt_sub_0_100k_1mps`_   |
+--------------------------+-----------------------+------------+---------------+-----------------+---------------------------+

-------------------
QoS1 Fan-In消息吞吐
-------------------

+--------------------------+-------+-----------+--------------------+---------------------+---------------------+------------+
|  组合场景ID              |  QoS  |  Payload  |  PUB连接 X Fan-In  |  SUB连接 X Fan-Out  |  Fan-In(平均/峰值)  |  背景连接  |
+==========================+=======+===========+====================+=====================+=====================+============+
|  qos1-p256-30K-0         |  1    |  256      |  3K X 10           |  0                  |  16.6K / 19.3K      |  100K      |
+--------------------------+-------+-----------+--------------------+---------------------+---------------------+------------+
|  qos1-p1K-20K-0          |  1    |  1K       |  2K X 10           |  0                  |  13.9K / 15.4K      |  100K      |
+--------------------------+-------+-----------+--------------------+---------------------+---------------------+------------+
|  qos1-p10K-5K-0          |  1    |  10K      |  1K X 5            |  0                  |  3.8K / 4.6K        |  100K      |
+--------------------------+-------+-----------+--------------------+---------------------+---------------------+------------+

资源占用报告:

+--------------------------+-----------------------+------------+---------------+-----------------+---------------------------+
|  组合场景ID              | 网络吞吐(Avg/Max Bps) | 负载(Load) | CPU(user/sys) | Memory(Avg/Max) | 测试报告                  |
+==========================+=======================+============+===============+=================+===========================+
|  qos1-p256-30K-0         | _/7.36M               | 7/5/2      | 不超过64% /10%| _/1.98G         | `mqtt_pub_1_256p_10mps`_  |
+--------------------------+-----------------------+------------+---------------+-----------------+---------------------------+
|  qos1-p1K-20K-0          | _/17.239M             | 6/5/2      | 不超过71% / 8%| _/2.26G         | `mqtt_pub_1_1kp_10mps`_   |
+--------------------------+-----------------------+------------+---------------+-----------------+---------------------------+
|  qos1-p10K-5K-0          | _/45.98M              | 8/5/3      | 不超过81% / 9%| _/2.236G        | `mqtt_pub_1_10kp_5mps`_   |
+--------------------------+-----------------------+------------+---------------+-----------------+---------------------------+

--------------------
QoS1 Fan-Out消息吞吐
--------------------

+--------------------------+-------+-----------+--------------------+---------------------+---------------------+-------------+
|  组合场景ID              |  QoS  |  Payload  |  PUB连接 X Fan-In  |  SUB连接 X Fan-Out  |  Fan-Out(平均/峰值) |  背景连接   |
+==========================+=======+===========+====================+=====================+=====================+=============+
|  qos1-p256-4-40K         |  1    |  256      |  4 X 1             |  10K X 4            |  23K / 27.7K        |  100K       |
+--------------------------+-------+-----------+--------------------+---------------------+---------------------+-------------+
|  qos1-p1K-3-30K          |  1    |  1K       |  3 X 1             |  10K X 3            |  17.5 / 20.5K       |  100K       |
+--------------------------+-------+-----------+--------------------+---------------------+---------------------+-------------+
|  qos1-p10k-1-5K          |  1    |  10K      |  1 X 1             |  5K X 1             |  4906 / 5000        |  100K       |
+--------------------------+-------+-----------+--------------------+---------------------+---------------------+-------------+

资源占用报告:

+--------------------------+-----------------------+------------+----------------+-----------------+---------------------------+
|  组合场景ID              | 网络吞吐(Avg/Max Bps) | 负载(Load) | CPU(user/sys)  | Memory(Avg/Max) | 测试报告                  |
+==========================+=======================+============+================+=================+===========================+
|  qos1-p256-4-40K         | _/11.44M              | 8/5/2      | 不超过80% / 8% | _/2.504G        | `mqtt_sub_1_256_10mps`_   |
+--------------------------+-----------------------+------------+----------------+-----------------+---------------------------+
|  qos1-p1k-3-30K          | _/24.44M              | 7/5/3      | 不超过84% / 7% | _/3.20G         | `mqtt_sub_1_1kp_10mps`_   |
+--------------------------+-----------------------+------------+----------------+-----------------+---------------------------+
|  qos1-p10k-1-5K          | _/64.8M               | 8/5/3      | 不超过64% / 15%| _/26.67G        | `mqtt_sub_1_10k_5mps`_    |
+--------------------------+-----------------------+------------+----------------+-----------------+---------------------------+

-------------------
QoS2 Fan-In消息吞吐
-------------------

+--------------------------+-------+-----------+--------------------+---------------------+---------------------+-------------+
|  组合场景ID              |  QoS  |  Payload  |  PUB连接 X Fan-In  |  SUB连接 X Fan-Out  |  Fan-In(平均/峰值)  |  背景连接   |
+==========================+=======+===========+====================+=====================+=====================+=============+
|  qos2-p256-20K-0         |  2    |  256      |  4k X 5            |  0                  |  9.6K  / 10.5K      |  100K       |
+--------------------------+-------+-----------+--------------------+---------------------+---------------------+-------------+
|  qos2-p1K-10K-0          |  2    |  1K       |  2k X 5            |  0                  |  6.4K  / 6.9K       |  100K       |
+--------------------------+-------+-----------+--------------------+---------------------+---------------------+-------------+
|  qos2-p10K-3k-0          |  2    |  10K      |  600 X 5           |  0                  |  225  / 409         |  100K       |
+--------------------------+-------+-----------+--------------------+---------------------+---------------------+-------------+

资源占用报告:

+--------------------------+-----------------------+------------+---------------+-----------------+---------------------------+
|  组合场景ID              | 网络吞吐(Avg/Max Bps) | 负载(Load) | CPU(user/sys) | Memory(Avg/Max) | 测试报告                  |
+==========================+=======================+============+===============+=================+===========================+
|  qos2-p256-20K-0         | _/5.712M              | 6/4/3      | 不超过66% /12%| _/2.02G         | `mqtt_pub_2_256p_5mps`_   |
+--------------------------+-----------------------+------------+---------------+-----------------+---------------------------+
|  qos2-p1k-10K-0          | _/8.87M               | 7/5/4      | 不超过58% / 9%| _/1.98G         | `mqtt_pub_2_1kp_5mps`_    |
+--------------------------+-----------------------+------------+---------------+-----------------+---------------------------+
|  qos2-p10k-3k-0          | _/39.4M               | 8/6/4      | 不超过70% /13%| _/5.822G        | `mqtt_pub_2_10kp_5mps`_   |
+--------------------------+-----------------------+------------+---------------+-----------------+---------------------------+

.. TODO:: p10K报文结果待确认.

--------------------
QoS2 Fan-Out消息吞吐
--------------------

+--------------------------+-------+-----------+--------------------+---------------------+---------------+-------------+
|  组合场景ID              |  QoS  |  Payload  |  PUB连接 X Fan-In  |  SUB连接 X Fan-Out  |  实际Fan-Out  |  背景连接   |
+==========================+=======+===========+====================+=====================+===============+=============+
|  qos2-p256-4-20K         |  2    |  256      |  4 X 1             |  5K X 4             |  16.8K/18K    |  100K       |
+--------------------------+-------+-----------+--------------------+---------------------+---------------+-------------+
|  qos2-p1K-2-10K          |  2    |  1K       |  2 X 1             |  5K X 2             |  10K/10.2K    |  100K       |
+--------------------------+-------+-----------+--------------------+---------------------+---------------+-------------+
|  qos2-p10K-1-1K          |  2    |  10K      |  1 X 1             |  1K X 1             |  200/400      |  100K       |
+--------------------------+-------+-----------+--------------------+---------------------+---------------+-------------+

资源占用报告:

+--------------------------+-----------------------+------------+---------------+-----------------+---------------------------+
|  组合场景ID              | 网络吞吐(Avg/Max Bps) | 负载(Load) | CPU(user/sys) | Memory(Avg/Max) | 测试报告                  |
+==========================+=======================+============+===============+=================+===========================+
|  qos2-p256-4-20K         |               |       | |         |    |
+--------------------------+---------------+-------+-+---------+----+
|  qos2-p1k-3-10K          |               |       | |         |    |
+--------------------------+---------------+-------+-+---------+----+
|  qos2-p10k-1-1K          |               |       | |         |    |
+--------------------------+-----------------------+------------+---------------+-----------------+---------------------------+

.. TODO:: p10K报文结果待确认.

--------
共享订阅
--------

QoS0共享订阅消费
----------------

.. TODO:: 

QoS1共享订阅消费
----------------

.. TODO:: 

QoS2共享订阅消费
----------------

.. TODO:: 

----------------
Fastlane消息吞吐
----------------

QoS0 Fastlane消费
-----------------

.. TODO:: 

.. _mqtt_pub_0_256p_10mps: https://www.xmeter.net/commercialPage.html#/testrunMonitor/1423085729
.. _mqtt_pub_0_1k_10mps: https://www.xmeter.net/commercialPage.html#/testrunMonitor/809361614
.. _mqtt_pub_0_10k_10mps: https://www.xmeter.net/commercialPage.html#/testrunMonitor/2096357643
.. _mqtt_pub_0_100k_10mps: https://www.xmeter.net/commercialPage.html#/testrunMonitor/605637990
.. _mqtt_sub_0_256p_1mps: https://www.xmeter.net/commercialPage.html#/testrunMonitor/1356775835
.. _mqtt_sub_0_1kp_1mps: https://www.xmeter.net/commercialPage.html#/testrunMonitor/1363767301
.. _mqtt_sub_0_10kp_1mps: https://www.xmeter.net/commercialPage.html#/testrunMonitor/1106046395
.. _mqtt_sub_0_100k_1mps: https://www.xmeter.net/commercialPage.html#/testrunMonitor/1360282139
.. _mqtt_pub_1_256p_10mps: https://www.xmeter.net/commercialPage.html#testrunMonitor/1668250312
.. _mqtt_pub_1_1kp_10mps: https://www.xmeter.net/commercialPage.html#testrunMonitor/1436230490
.. _mqtt_pub_1_10kp_5mps: https://www.xmeter.net/commercialPage.html#testrunMonitor/1811352442
.. _mqtt_sub_1_256_10mps: https://www.xmeter.net/commercialPage.html#testrunMonitor/572548073
.. _mqtt_sub_1_1kp_10mps:  https://www.xmeter.net/commercialPage.html#testrunMonitor/1053775356
.. _mqtt_sub_1_10k_5mps:  https://www.xmeter.net/commercialPage.html#testrunMonitor/1948638282
.. _mqtt_pub_2_256p_5mps: https://www.xmeter.net/commercialPage.html#testrunMonitor/246653627
.. _mqtt_pub_2_1kp_5mps: https://www.xmeter.net/commercialPage.html#testrunMonitor/570500370
.. _mqtt_pub_2_10kp_5mps: https://www.xmeter.net/commercialPage.html#testrunMonitor/919262221

